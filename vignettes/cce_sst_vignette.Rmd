---
title: "cce_watertemp_vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cce_watertemp_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE
)
```

```{r setup}
library(alohakez)
library(tidyverse)
```

## California Current Ecosystem (CCE) LTER
## Shore Stations Program SIO Pier Water Temperature
### Daily sea-surface temperature(SST) measurements, collected and provided by the Shore Stations Program, La Jolla CA, 1916 - May 2019


#### Let's take a look at the data first
```{r}
cce_sst %>% head()
sapply(cce_sst, typeof)
```

#### Filter valid data: flag 0 stands for good data 
```{r}
watertemp <- cce_sst %>%
  filter(sea_surface_temperature_flag==0) %>%
  filter(!is.na(sea_surface_temperature_c))
```

##### store invalid
```{r}
tmp <- cce_sst %>%
  filter(sea_surface_temperature_flag!=0 | is.na(sea_surface_temperature_c)) 
tmp %>% group_by(year) %>% count() %>% head(10)
```

##### Initial years contain large amount of invalid/missing data
##### we will look at data from 1930 onward


### Calculate annual average 
### Calculate lowest and highest temperature over years

```{r}
annual_temp <- watertemp %>%
  group_by(year) %>%
  summarize(annual_avg = mean(sea_surface_temperature_c,),
            min_temp = min(sea_surface_temperature_c),
            max_temp = max(sea_surface_temperature_c)) %>%
  mutate(diff=max_temp-min_temp)
```

#### let's look at the annual temperature over years
```{r}
annual_temp %>%
  filter(year>=1930) %>%
  ggplot(aes(x = year, y = annual_avg)) +
  geom_path(color="blue") +
  labs(x = "Year",
       y = "Mean Sea-Surface Temperature (C)",
       title = "Annual Mean Sea-Surface Temperature from 1930 to 2015 (C)") +
  theme_bw() +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10))
```

#### now see the min and max temp over years
```{r}
annual_temp %>%
  filter(year>=1930) %>%
  ggplot(aes(x = year)) +
  geom_path(aes(y=min_temp), color="blue") +
  geom_path(aes(y=max_temp), color="orange") +
  labs(x = "Year",
       y = "Sea-Surface Temperature (C)",
       title = "Lowest and Highest Day Sea-Surface Temperature (C)") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal()
```

#### let's see if there's anything interesting about the max difference temp in years
```{r}
annual_temp %>%
  filter(year>=1930) %>%
  ggplot(aes(x = year, y = diff)) +
  geom_path() +
  labs(x = "Year",
       y = "Sea-Surface Temperature (C)",
       title = "Difference") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10))
```

### Calculate monthly average, minimum, and maximum
```{r}
monthly_temp <- watertemp %>%
  group_by(year, month) %>%
  summarize(monthly_avg = mean(sea_surface_temperature_c),
            min_temp = min(sea_surface_temperature_c),
            max_temp = max(sea_surface_temperature_c))
```

### let's see how temp varies over month for recent years
```{r}
monthly_temp %>%
  filter(year>2005 & year<2015) %>%
  ggplot() +
  geom_path(aes(x=factor(month), y=monthly_avg, 
                group=factor(year), color=factor(year)), size=1) +
  theme_minimal() +
  labs(x="year", y="monthly average temperature", 
       color="year",
       title="temperature change monthly trends in recent years")
```

#### plotting them on same graph seems a little messy 
#### look at them separately
```{r}
monthly_temp %>%
  filter(year>2002 & year<2015) %>%
  ggplot() +
  geom_path(aes(x=factor(month), y=monthly_avg, 
                group=factor(year), color="dodgerblue"), size=1.2) +
  theme_classic() +
  facet_wrap(~year) +
    labs(x="year", y="", 
       title="monthly average temperature in recent years") +
  theme(legend.position = "none")
```


### when does temperature reach highest every year
```{r}
highest_temp <-watertemp %>%
    mutate(date_pst=as.Date(date_pst, "%Y/%m/%d")) %>%
    group_by(year) %>%
    slice(which.max(sea_surface_temperature_c))
highest_temp <- highest_temp %>%
    mutate(month_day=as.Date(paste(2222, month, day, sep = "/" )))
highest_temp %>% head()
highest_temp %>% tail()
```

#### map it
```{r}
highest_temp %>%
  filter(year>=1930) %>%
  ggplot(aes(x=year, y=month_day)) +
  geom_path(color="sienna1", size=1) +
  scale_y_date(date_breaks = "10 days", date_labels = "%b%d") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  geom_text(aes(label=sea_surface_temperature_c), 
            angle=10, size=3.2, vjust=0.5, color="darkgreen") +
  labs(y="date", title="highest temperature in year") +
  theme_classic()
```
#### varies, but within our expectations

### let's try the same thing for lowest
```{r}
lowest_temp <-watertemp %>%
    mutate(date_pst=as.Date(date_pst, "%Y/%m/%d")) %>%
    group_by(year) %>%
    slice(which.min(sea_surface_temperature_c))
lowest_temp <- lowest_temp %>%
    mutate(month_day=as.Date(paste(2222, month, day, sep = "/" )))
lowest_temp %>% head()
lowest_temp %>% tail()
```

#### map it
```{r}
lowest_temp %>%
  filter(year>=1930) %>%
  ggplot() +
  geom_point(aes(x=year, y=month_day)) +
  scale_y_date(date_breaks = "1 month", date_labels = "%b%d")
```

#### hard to see, let's modify the month_day variable
#### we'll chose November as a cutoff
```{r}
lowest_temp <- watertemp %>%
    mutate(date_pst=as.Date(date_pst, "%Y/%m/%d")) %>%
    group_by(year) %>%
    slice(which.min(sea_surface_temperature_c))
lowest_temp <- lowest_temp %>%
    mutate( month_day = as.Date(ifelse(month>=11,
                               paste(2222, month, day, sep = "/" ), paste(2223, month, day, sep = "/" ) 
                               )) )
lowest_temp %>% head()
lowest_temp %>% tail()
```

### now map again
```{r}
lowest_temp %>%
  filter(year>=1930) %>%
  ggplot(aes(x=year, y=month_day)) +
  geom_point(color="slateblue3") +
  scale_y_date(date_breaks = "1 month", date_labels = "%b%d") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  geom_text(aes(label=sea_surface_temperature_c), 
            angle=10, size=3, hjust=1, vjust=1, color="brown") +
  labs(y="date", title="lowest temperature in year")
```

#### interesting result
#### could be result of incorrect entries or irregular weathers on these days

